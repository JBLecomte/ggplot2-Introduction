---
title: "Introduction to ggplot2"
author: "Jean-Baptiste Lecomte"
output:
  slidy_presentation:
    df_print: paged
  beamer_presentation: default
---

```{r  setup, include=FALSE}
library(knitr)
opts_chunk$set(fig.path = 'figure/',
               fig.align = 'center',
               # fig.show = 'hold',
               out.width = '90%',
               tidy = FALSE)

opts_template$set(
  fig.fullpage = list(fig.width = 8, fig.height = 12),
  fig.large_square = list(fig.width = 8, fig.height = 8),
  fig.large = list(fig.width = 8, fig.height = 5),
  fig.medium = list(fig.width = 8, fig.height = 4.5),
  fig.small = list(fig.width = 8, fig.height = 3)
)

library("tidyverse")

source('R/Data_Simulation/Data_Simulation_Year.R')

source('R/Palette/colorblind_palette.R')
source('R/Palette/custom_palette.R')

### Function to change label in faceted plot
source('R/Fun/fn_alphabetic_label.R')
source('R/Fun/fn_TeX_label.R')

### Function to display multiple-ggplots 
source('R/Fun/gg_multiplot.R')
```


## Introduction
- based on *The grammar of graphics* developed by Wilkinson in 2005
- highly recommended R packages to work with ggplot2: dplyr and the tidyverse

```{r, eval = FALSE, echo = FALSE, out.width = "50%", out.height = "30%",  fig.show = 'asis', fig.align = 'default'}
book_images<-list.files("figure/", pattern = ".jpg", full.names = TRUE)
knitr::include_graphics(book_images)
```

```{r, eval = TRUE, echo = FALSE, out.width = "50%", out.height = "30%",  fig.show = 'asis', fig.align = 'center'}
knitr::include_graphics('figure/tidyverse.png')
```



## Principle
ggplot2 is based on a **layer** system which can be used as objects.\\
Main layers

- data $\rightarrow$ raw data
- mapping $\rightarrow$ graphic projection
- geom $\rightarrow$ geometric objects (points, lines, polygons, ...)
- stat $\rightarrow$ statistics transformation (histogram, model)
- scale $\rightarrow$ aesthetics customization (colour, shape, size, axes, legend)
- coord $\rightarrow$ coordinate system (axes, grid)
- facet $\rightarrow$ subdivision (lattice, trellis)

## Getting Started

Always work with a data.frame

Our data frame is based on the Hecate Strait Synoptic Trawl Survey and simulated data.

Download all the codes from a Github repository: 
<https://github.com/JBLecomte/ggplot2-Introduction.git>


## Getting Started
```{r str_data}
df_data
```

## Scatter plot : Depth and Biomass
```{r sp_base, eval=TRUE,  opts.label='fig.medium'}
sp <- ggplot(data=df_data, aes(x=Depth, y=Biomass)) +
  geom_point()
print(sp)
```


## Scatter plot with color : Depth and Biomass
```{r sp_color, eval=TRUE, opts.label='fig.medium'}
sp_color <- ggplot(df_data, aes(x=Depth, y=Biomass, color=AREA)) +
  geom_point()
print(sp_color)
```



## Scatter plot with shape : Depth and Biomass
```{r sp_shape, eval=TRUE, opts.label='fig.medium'}
sp_shape <- ggplot(df_data, aes(x=Depth, y=Biomass, color=AREA, shape=Year_fac)) +
  geom_point()
print(sp_shape)
```

## Improvement of a plot : axes names
```{r sp_shape_imp1, eval=TRUE,   opts.label='fig.medium'}
sp_shape_imp1 <- sp_shape + 
  xlab('Average net depth (m)') +
  ylab('Biomass (kg)')
print(sp_shape_imp1)
```

## Improvement of a plot : legend titles
```{r sp_shape_imp2, eval=TRUE,   opts.label='fig.medium'}
sp_shape_imp2 <- sp_shape_imp1 + 
  scale_shape_discrete(name="Years") + scale_color_discrete(name="Area")
print(sp_shape_imp2)
```



## Improvement of a plot : plot title
```{r sp_shape_imp3, eval=TRUE,   opts.label='fig.medium'}
sp_shape_imp3 <- sp_shape_imp2 + 
  ggtitle("Biomass of species X and average net depth")
print(sp_shape_imp3)
```

## Discrete color scale
```{r sp_discrete_color1, eval=TRUE,   opts.label='fig.medium'}
sp_c <- ggplot(df_data, aes(x=Depth, y=Biomass,
                            color=Year_fac)) +
  geom_point() + xlab('Average net depth (m)')
print(sp_c)
```

## Discrete color scale : brewer palette
```{r sp_discrete_color4, eval=TRUE,   opts.label='fig.medium'}
sp_c_brewer <- sp_c +
  scale_color_brewer(name='Year', palette="Dark2")
print(sp_c_brewer)
```

## Discrete color scale : brewer palette
```{r sp_discrete_color4b, eval=TRUE,   opts.label='fig.medium'}
sp_c_brewer <- sp_c +
  scale_color_brewer(name='Year', palette="Set1")
print(sp_c_brewer)
```

## Discrete color scale : *scale_color_grey*
```{r sp_discrete_color5, eval=TRUE,   opts.label='fig.medium'}
sp_c_grey <- sp_c +
  scale_color_grey(name='Year')
print(sp_c_grey)
```

## Continuous color scale
```{r sp_continuous_color1, eval=TRUE,   opts.label='fig.medium'}
sp_cc <- ggplot(data = df_data, aes(x=Temp, y=Depth)) +
  geom_point(alpha=0.8, aes(colour=Biomass)) + 
  xlab('Average net temperature (C)') + ylab('Average net depth (m)')
print(sp_cc)
```


## Continuous color scale: choose color
```{r sp_continuous_color2, eval=TRUE,   opts.label='fig.medium'}
sp_cc2 <- sp_cc +
  scale_colour_gradient(low = 'blue', high = 'red')
print(sp_cc2)
```

## Time series
```{r sp_TSplot_year, eval=TRUE,   opts.label='fig.medium'}
TSplot_year <- ggplot(data=df_data, aes(x=Year, y=Biomass)) + 
  geom_point()
print(TSplot_year)
```

## Time series: summarize
Summarize the data with the mean, median and quantiles for easy plotting.
The ddply function from the plyr R package provides an easy way to summarize the data.
```{r summary_data_year, eval=TRUE,   opts.label='fig.medium'}
df_summary <- df_data %>% group_by(Year) %>% summarise(
  B_mean=mean(Biomass),
  B_median=median(Biomass),
  B_sd=sd(Biomass),
  B_q025=quantile(Biomass, probs = 0.025),
  B_q05=quantile(Biomass, probs = 0.05),
  B_q10=quantile(Biomass, probs = 0.10),
  B_q50=quantile(Biomass, probs = 0.50),
  B_q90=quantile(Biomass, probs = 0.90),
  B_q95=quantile(Biomass, probs = 0.95),
  B_q975=quantile(Biomass, probs = 0.975))
```


## Time series: summarize
Summarize the data with the mean, median and quantiles for easy plotting.
The ddply function from the plyr R package provides an easy way to summarize the data.
```{r summary_data_year2, eval=TRUE,   opts.label='fig.medium'}
df_summary
```

## Time series with 95% intervals
```{r sp_TSplot_i95a, eval=TRUE,   opts.label='fig.medium'}
TSplot_i95 <- ggplot(data=df_summary, aes(x=Year, y=B_mean)) + 
  geom_point()
print(TSplot_i95)
```


## Time series with 95% intervals
```{r sp_TSplot_i95b, eval=TRUE,   opts.label='fig.medium'}
TSplot_i95 <- TSplot_i95 +
  geom_pointrange(aes(ymin = B_q025, ymax = B_q975))
print(TSplot_i95)
```

## Time series : improvement
```{r sp_TSplot_i95_imp, eval=TRUE,   opts.label='fig.medium'}
TSplot_i95 <- ggplot(data=df_summary, aes(x=Year, y=B_mean)) + 
  geom_point() + geom_pointrange(aes(ymin = B_q025, ymax = B_q975)) +
  ylab('Biomass') +
  scale_x_continuous(name = 'Year', breaks = seq(2005, 2013, by = 1))
print(TSplot_i95)
```

## Boxplot
```{r boxplot_TS, eval=TRUE,   opts.label='fig.medium'}
boxplot_TS <- ggplot(data=df_data, aes(x=Year, y=Biomass)) + 
  geom_boxplot()
print(boxplot_TS)
```



## Boxplot with Year as a factor
```{r boxplot_TSf, eval=TRUE,   opts.label='fig.medium'}
boxplot_TSf <- ggplot(data=df_data, aes(x=factor(Year), y=Biomass)) + 
  geom_boxplot() 
print(boxplot_TSf)
```


## Boxplot with Year and Area as a factor
```{r boxplot_TSf_AREA, eval=TRUE,   opts.label='fig.medium'}
boxplot_TS_AREA <- ggplot(data=df_data, aes(x=factor(Year), y=Biomass, 
                                            colour=AREA)) +
  geom_boxplot()
print(boxplot_TS_AREA)
```

## Faceting: *facet_grid*
```{r facet_wrap_0, eval=TRUE,   opts.label='fig.medium'}
hist <- ggplot(data=df_data, aes(x=Duration, fill=AREA)) +
  geom_histogram()
print(hist)
```


## Faceting: *facet_grid*
```{r facet_grid_1, eval=TRUE,   opts.label='fig.medium'}
fw1 <- ggplot(data=df_data, aes(x=Duration)) +
  geom_histogram(binwidth=1) + 
  xlab('Duration of a tow (in minutes)') + ylab('Number of tows') +
  facet_grid(~ AREA)
print(fw1)
```

## Faceting: *facet_grid*
```{r facet_wrap_1, eval=TRUE,   opts.label='fig.medium'}
fw1 <- ggplot(data=df_data, aes(x=Duration)) +
  geom_histogram(binwidth=1) +
  xlab('Duration of a tow (in minutes)') + ylab('Number of tows') +
  facet_grid(~ AREA, scales = 'free_x')
print(fw1)
```


## Faceting: *facet_grid*
```{r facet_wrap_5, eval=TRUE,   opts.label='fig.medium'}
fw2 <- ggplot(data=df_data, aes(x=Duration)) +
  geom_histogram(binwidth=1) + 
  xlab('Duration of a tow (in minutes)') + ylab('Number of tows') +
  facet_grid(AREA ~ Year_fac)
print(fw2)
```


## Faceting: *facet_grid*
```{r facet_wrap_6, eval=TRUE,   opts.label='fig.medium'}
fw2_2 <- ggplot(data=df_data, aes(x=Duration)) +
  geom_histogram(binwidth=1) + 
  xlab('Duration of a tow (in minutes)') + ylab('Number of tows') +
  facet_grid( ~ Year_fac + AREA)
print(fw2_2)
```

## Theme

- ggplot2 uses a theme which controls the background, fonts, text size, ...
- change the theme for the current R session: 
```{r  eval=FALSE} 
theme_set(theme_gray())
```
- create or update your own theme :
```{r  eval=FALSE} 
p + theme(plot.background = element_rect(fill = "darkblue"))
```

## Theme: black and white
```{r theme_2, eval=TRUE,   opts.label='fig.medium'}
print(fw2 + theme_bw())
```


## Theme: classic
```{r theme_3, eval=TRUE,   opts.label='fig.medium'}
print(fw2 + theme_classic())
```

## Saving a plot
The ggsave function from ggplot2 package allows to automatically save a plot.
```{r ggsave1, eval=FALSE,   opts.label='fig.medium'}
print(fw2)

ggsave(plot=fw2, filename = 'fw2.pdf', path = '~/figure',
       width = 8, height = 5, units = 'cm')
```


## Online resources

- ggplot2 official documentation:\\ <http://docs.ggplot2.org/current/>
- R code related to ggplot2 cookbook:\\<http://www.cookbook-r.com/Graphs/>
- R code related to useR! ggplot2 book:\\<http://ggplot2.org/book/>
- Statistical tools for high-throughput data analysis:\\<http://www.sthda.com/english/wiki/ggplot2-essentials>
- Github repository:\\<https://github.com/yhat/ggplot/>
- RStudio Cheat Sheet :\\<http://www.rstudio.com/wp-content/uploads/2015/12/ggplot2-cheatsheet-2.0.pdf>



## Useful R packages which use ggplot2

- A website which references ggplot2 extension <https://ggplot2-exts.github.io/index.html>

- **ggfortify** and its autoplot() function allows plotting some popular R packages using a standardized approach.
Diagnostic plots with Generalized Linear Models (GLM), Plotting Principal Component Analysis ...

- **ggmcmc** was developed to plot MCMC outputs from OpenBUGS, JAGS or Stan. It provides plots to assess the convergence and general behaviour of MCMC chains. <http://xavier-fim.net/post/using_ggmcmc/>

- **GGally** regroups R packages which extend ggplot2. The main reason to use GGally is its correlation plots.

- **latex2exp** allows to replace labels and titles with latex expression in plot.

